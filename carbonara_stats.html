<html>
<head>
<meta charset="utf-8">
<style>

.arc text {
  font: 10px sans-serif;
  text-anchor: middle;
}

.arc path {
  stroke: #fff;
}

</style>

<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
<script>
//https://bl.ocks.org/mbostock/1346410
var dbMap = {'PoG': 'Solo Pancetta o Guanciale', 'C': 'Con Cipolla' ,
'A' : 'Con Aglio' , 'non_sa': 'Non sa, non dice' , 'Y': 'Si' , 'N': 'No',
'Altro': 'Altro', 'Parmigiano' : 'Parmigiano', 
'Pecorino Romano': 'Pecorino Romano', 'P':'Prima', 'D':'Dopo', 
'PD':'Prima e dopo' , '+':'Piu uova che persone' , 
'-': 'Meno uova che persone' , '=': 'Tante uova quante persone'};

var width = 960,
    height = 500,
    radius = Math.min(width, height) / 2;

//var color = d3.scale.ordinal()
//    .range(["#98abc5", "#8a89a6", "#7b6888", "#6b486b", "#a05d56", "#d0743c", "#ff8c00"]);
var color = d3.scale.category10();

var arc = d3.svg.arc()
    .outerRadius(radius - 10)
    .innerRadius(radius - 170);

var pie = d3.layout.pie()
    .sort(null)
    .value(function(d,i) { 
    	k = Object.keys(d)[0]; 
	return d[k]; });

var recdata ;

var remoteFetch = function(url, action , callback){
	var ajaxPars = {
			url: url,
			type : "GET",
			data : {action: action},
			beforeSend: function(jqXHR, settings ) { 
				
				return true;
			} ,
			complete: function( jqXHR, textStatus ){
				
			} , 
			error: function(){
			//	if (callback) callback.call(this, []);
			}, 
			fail: function(err) { alert (err); },
			success: function (data, textStatus, jqXHR) {
				//json = data;
				
				//pagination.push(jqXHR.getResponseHeader('Link'));
				
				// CONTINUE FROM HERE
				//rgx = new RegExp("/<([^>]+)>; rel=\"next\"/")
				//if (rgx.match()
				
				//console.log("pagination " + pagination);
				console.log("success");
				
				recdata = JSON.parse(data);

				callback(recdata);
				//x = recdata[1];
				//createPieChart(x[Object.keys(x)[0]]);
				//console.log(data);

			} ,
			
		};
		//console.log(ajaxPars.url);
		$.ajax(ajaxPars);


}

var createPieCharts = function (data,which){

	data.forEach(x=> {
		k = Object.keys(x)[0];
		console.log("CreatePieChart for " + Object.keys(x)[0]);
		createPieChart(x[k],k);
		});
	//createPieChart(data[which]);

}

//var piedata ;
var counter = 0;
var createPieChart = function(data, title){
	console.log("call createPieChart");
	//piedata = pie(data);
	svg.attr("height" , height * (data.length + 0.5));
	shift = counter %2 == 0? 1: 2;
        var thepie = svg.selectAll(".pie")
		.data([]).remove()
		.data([title])
		.enter()
	        .append("g")
                .attr("transform", function(d, i) { return "translate(" +
		    shift * width / 2 + "," +  (counter + 1) * height / 2 + ")" ;})
                .attr("class", "pie");
	counter++;
		
	var g =	thepie.selectAll(".arc")
		.data([]).remove()
		.data(pie(data))
		.enter()
	        .append("g")
		.attr("class", "arc");
 	
	//console.log(arc);
 	g.append("path")
	  .attr("d", arc)
	  .style("fill", function(d,i) {
		  return color(i); });

	g.append("text")
	 .attr("transform", function(d) { 

	 	k = Object.keys(d['data'])[0];
		v = d['data'][k];
	 	//console.log("d[k] " + v + " centroid " + arc.centroid(d));
	 	return "translate(" + arc.centroid(d) + ")"; })
	 .attr("dy", ".35em")
	 .text(function(d) { 
	 	k = Object.keys(d['data'])[0];
		console.log("Text: " + dbMap[k] + " " + k );
		return dbMap[k]; });
	thepie.append("g")
	      .append("text")
	      .text(title)
	      .attr("transform" , "translate(-60,0)");

}
var updatePieChart = function(data){
	console.log("call updatePieChart");
	//piedata = pie(data);
        svg.selectAll('.arc').data(pie(data)).enter();
}
</script>
</head>
<body>

<script>
var histodata = [];
/*var question = {"chiara": {"Y":2 , "N":1 , "non_sa": 0} , 
		    "formaggio": {"P":3 , "D":2, "PD":1 , "non_sa" :0} , 
		    "kindaformaggio" : {"Pecorino Romano":3, "Parmigiano":2 ,
		    "Altro" : 1, 'non_sa' : 0},
	 	    "padella": {"Y":2 , "N" : 1, "non_sa":0} , 
		    "pepe" : {"Y":2 , "N" : 1, "non_sa":0} ,
		    "peperoncino": {"Y":2 , "N" : 1, "non_sa":0} ,
		    "persone_uova": {"+":3 , "-" : 2, "=": 1, "non_sa":0}  , 
		    "soffritto" : {"PoG" : 3 , "C": 2, "A": 1, "non_sa":0}};
*/

var question = [{"chiara": {"Y":2 , "N":1 , "non_sa": 0}} , 
		    {"formaggio": {"P":3 , "D":2, "PD":1 , "non_sa" :0} }, 
		    {"kindaformaggio" : {"Pecorino Romano":3, "Parmigiano":2 ,
		    "Altro" : 1, 'non_sa' : 0}},
	 	    {"padella": {"Y":2 , "N" : 1, "non_sa":0}} , 
		    {"pepe" : {"Y":2 , "N" : 1, "non_sa":0} },
		    {"peperoncino": {"Y":2 , "N" : 1, "non_sa":0} },
		    {"persone_uova": {"+":3 , "-" : 2, "=": 1, "non_sa":0} } , 
		    {"soffritto" : {"PoG" : 3 , "C": 2, "A": 1, "non_sa":0}}];
var createRecipeIndex = function(datum){

	keys_datum = Object.keys(datum);
	//keys_q = Object.keys(question);

        /*
	idx = keys_datum.reduce((x,y)=> {
		col = $.inArray(keys_datum[x],keys_q);
		if ( col>=0 ){
			dx = datum[x];
			qdx = question[dx];
			return col * 4 * question[datum[x]] ;
		} else 
			return 0; 
	} , 0 )
	*/
	idx = 0;
	for (i=0; i<question.length; i++){
		thekey = Object.keys(question[i])[0];
		p = datum[thekey];
		if ( p === null ) {
			p = 'non_sa';
		}
		thisvalue = question[i][thekey][p]
		idx += thisvalue * Math.pow(4, i);
	}

	/*
	for (i = 0; i < keys_datum.length; i++){
		col = $.inArray(keys_datum[i], keys_q);
		if (col >=0){
			x = keys_datum[i];
			dx = datum[x];
			if (typeof dx === 'undefined'){
				dx = 'non_sa';
			} else if (dx == null){
				dx = 'non_sa';
			}
			qdx = question[x][dx];
			if (qdx != 0){
			    addidx =  Math.pow(4,col) * qdx ;
			    idx += addidx;
			}
		}
	}
	*/

	return idx;
}

var idx_data = [];
var hd = {}

var histo = function(data){

//create histogram with frequency of recipes
data.forEach(x=>histodata.push(x));
idx_data = histodata.map (x=>createRecipeIndex(x));

idx_data.forEach(x=> {
	if (hd.hasOwnProperty(x)){
		hd[x] += 1;
	} else {
		hd[x] = 1;
	}
});


}

var getRecipeFromIndex = function(index){
	recipe = {}
	for (i = question.length-1; i >=0 ;i--){
		quot = index / Math.pow(4,i);
		rest = index % Math.pow(4,i);
		integer = quot - rest / Math.pow(4,i);
		thekey = Object.keys(question[i])[0];
		options = question[i][thekey];
		ks = Object.keys(options);
		el = ks.filter(x=> {if (options[x] == integer){ return options;}});
		recipe[thekey] = el[0];
		index = index - integer * Math.pow(4,i);
	}
	return recipe;

}
var svg;
$(document).ready(function(){
svg = d3.select("body").append("svg")
    .attr("width", width * 2)
    .attr("height", height);

remoteFetch("http://edo.imanetti.net/carbonara/carb_api.php", "breakdown", createPieCharts);
remoteFetch("http://edo.imanetti.net/carbonara/carb_api.php", "get_all", histo);
})
</script>

</body>
</html>
